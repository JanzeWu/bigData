# Pipeline Recovery

## The Write Pipeline

当HDFS客户端写入文件时，数据将写为顺序块。为了编写或构造一个块，HDFS将块分成数据包，并将它们传播到写入管道中的DataNode。



写管道有三个阶段：

管道设置。客户端沿管道发送Write_Block请求，最后一个DataNode（副本）发回确认。收到确认后，管道已准备好写入。

数据流。数据以数据包的形式通过管道发送。客户端缓冲数据直到数据包被填满，然后将数据包发送到管道。如果客户端调用hflush()，那么即使数据包未满，仍发送到管道，并且在客户端接收到对先前的hflush'ed 数据包的确认之前，不会发送下一个数据包。

关闭（完成副本并关闭管道）。客户端等待所有数据包被确认，然后发送关闭请求。管道中的所有DataNode都将相应的副本更改为FINALIZED状态，并向NameNode报告。如果至少配置的DataNodes的最小复制数量报告了其相应副本的FINALIZED状态，则NameNode会将块的状态更改为COMPLETE。





## 从管道设置错误中恢复

如果为新块创建了管道，则客户端将放弃该块并向NameNode请求新块和新的DataNode列表。管道将重新初始化。并传播新的数据块。



## 从数据流故障中恢复

当管道中的DataNode检测到错误时，DataNode会通过关闭所有TCP/IP连接并将自己从管道中取出。如果数据被认为没有损坏，它还会将缓冲的数据写入相关的块和检验和文件。

当客户端检测到故障时，它会停止向管道发送数据，并使用剩余的良好的DataNode重新构建新管道。结果，块的所有副本都被提升到新的GS。

客户端恢复使用此新GS发送数据包。如果某些DataNode已经接收到所发送的数据，则它们只是忽略该数据并将其传递到管道中的下游。

## 从关闭失败中恢复

当客户端在关闭状态下检测到故障时，它会使用剩余的DataNode重建管道。 如果尚未最终确定副本，则每个DataNode都会突破块的GS并最终完成复制。

